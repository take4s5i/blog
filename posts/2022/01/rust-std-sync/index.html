<!DOCTYPE html>
<html lang="en">
	<head>
		<!-- Google Tag Manager -->
<!-- End Google Tag Manager -->

<!-- Global Metadata -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<link rel="icon" type="image/x-icon" href="/favicon.ico">

<!-- Primary Meta Tags -->
<title>take4s5i DEV - [Rust] 並列処理に使うAPIたち(Mutex, RwLock, Barrier, Condvar)</title>
<meta name="title" content="[Rust] 並列処理に使うAPIたち(Mutex, RwLock, Barrier, Condvar)">
<meta name="description">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url">
<meta property="og:title" content="[Rust] 並列処理に使うAPIたち(Mutex, RwLock, Barrier, Condvar)">
<meta property="og:description">
<meta property="og:image" content="https://astro.build/social.png?v=1">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url">
<meta property="twitter:title" content="[Rust] 並列処理に使うAPIたち(Mutex, RwLock, Barrier, Condvar)">
<meta property="twitter:description">
<meta property="twitter:image" content="https://astro.build/social.png?v=1">

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.gstatic.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=IBM+Plex+Sans:wght@400;700&display=swap">

	<link rel="stylesheet" href="/assets/9f5bbbfb.87948273.css" /><script type="module">(function(t,n,r,e,m){t[e]=t[e]||[],t[e].push({"gtm.start":new Date().getTime(),event:"gtm.js"});var g=n.getElementsByTagName(r)[0],a=n.createElement(r),s=e!="dataLayer"?"&l="+e:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+m+s,g.parentNode.insertBefore(a,g)})(window,document,"script","dataLayer","GTM-P42NKJ8");
</script></head>
	<body>
		<header class="wrapper astro-63D5MSV2">
	<article class="astro-63D5MSV2">
		<h1 class="astro-63D5MSV2">
			<a href="/" class="astro-63D5MSV2">
				<span class="astro-63D5MSV2">take4s5i DEV</span>
			</a>
		</h1>
	</article>
</header>


		<div class="wrapper">
			<div class="layout astro-57SHIKPC">
	<article class="content astro-57SHIKPC">
		<div class="astro-57SHIKPC">
			<header class="astro-57SHIKPC">
				
				<p class="publish-date astro-57SHIKPC">6 Jan 2022</p>
				<h1 class="title astro-57SHIKPC">[Rust] 並列処理に使うAPIたち(Mutex, RwLock, Barrier, Condvar)</h1>
			</header>
			<div class="editbar astro-57SHIKPC">
				<a href="https://github.com/take4s5i/blog/blob/main/src/pages/posts/2022/01/rust-std-sync.md" class="astro-57SHIKPC">Edit This Page</a>
			</div>
			<main class="astro-57SHIKPC">
				<p>最近業務でgoで並列処理を書くことがあり、Rustの場合はどうなっているのか気になったので調べてみました。</p><p><a href="https://doc.rust-lang.org/stable/std/sync/index.html">std::sync</a>モジュールの中をいろいろ見ていきたいと思います。</p><h1 id="mutex">Mutex</h1><p>まずは基本の<a href="https://doc.rust-lang.org/stable/std/sync/struct.Mutex.html">Mutex</a>から。</p><p>RustのMutexは単にロックを制御するだけではなく、ロックで守られたデータを持つことができます。
（データが不要で単にロックだけほしい場合はユニット型<code>()</code>を使えばよいですね）</p><p>Mutexでカウンタをつくり、 4スレッド起動し、各スレッドで100回インクリメントを行います。
<code>cnt</code>は400になるはずです。</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">sync</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span><span style="color: #FFA657">Arc</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Mutex</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">MutexGuard</span><span style="color: #C9D1D9">};</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">thread;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">N_THREADS</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> handles</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Vec</span><span style="color: #C9D1D9">&lt;thread</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">JoinHandle</span><span style="color: #C9D1D9">&lt;_&gt;&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Vec</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">with_capacity</span><span style="color: #C9D1D9">(N_THREADS);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> mutex</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Arc</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">Mutex</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">&gt;&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Arc</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Mutex</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _ </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #C9D1D9">N_THREADS {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> mutex </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> mutex</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">clone</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> handle </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">thread</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">spawn</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">move</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _ </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">100</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> cnt</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">MutexGuard</span><span style="color: #C9D1D9">&lt;_&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> mutex</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">lock</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">cnt </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        handles</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">(handle);</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(handle) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> handles</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">pop</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">        handle</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">join</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> cnt </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> mutex</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">lock</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;cnt = {}&quot;</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">cnt);</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre><p>出力:</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">cnt = 400</span></span></code></pre><p>ちゃんと400になりましたね。</p><p>まずMutexの生成ですが、通常、Mutexは複数スレッドで共有したいので<code>Arc&lt;T&gt;</code>を使います。
Mutex単体では<code>clone()</code>できませんが<code>Arc&lt;T&gt;</code>で包むことで複数スレッドでの共同所有を実現しています。
（<code>Arc&lt;T&gt;</code>は<code>Rc&lt;T&gt;</code>のスレッドセーフ版で、複数スレッドでの参照カウント方式のデータの共同所有ができます。そういえばこいつも<code>std::sync</code>ですね）</p><p>ロックの取得ですが<code>Mutex::lock()</code>を使います。
こいつは<code>LockResult&lt;MutexGuard&lt;T&gt;&gt;</code>という型のデータを返します。
<code>LockResult&lt;T&gt;</code> は<code>Result&lt;T, PoisonError&lt;T&gt;&gt;</code>という型のエイリアスです。</p><p>ロックを獲得した状態でそのスレッドがpanicすると、MutexがPoisoning状態になり、<code>lock()</code>がエラーを返すようになります。</p><p>無事ロックを獲得できると<code>MutexGuard&lt;T&gt;</code>が手に入りますが、こいつのライフタイムがそのままロックの取得期間になります。
つまり、スコープを抜けてdropされるとロックが解放されます。</p><p>Mutexで守られたデータのアクセスはこの<code>MutexGuard&lt;T&gt;</code>を使って行います。
可変参照を取得してデータを書き換えたり、不変参照を取って値を読み取ったりできます。</p><h1 id="rwlock">RwLock</h1><p><a href="https://doc.rust-lang.org/stable/std/sync/struct.RwLock.html">RwLock</a>はMutexに似たロック機構を提供しています。</p><ul>
<li>読み取り専用の共有ロック</li>
<li>読み書きできる排他ロック</li>
</ul><p>共有ロック取得中に排他ロックを取得したり、その逆はできません。
共有ロックは複数取得することができます。
(不変参照と可変参照のルールと同じですね）</p><p>メインスレッドで500msec毎にカウンタをインクリメントしていき、子スレッドでカウントが3より大きくなるまで待つ、ということをやってみようと思います。</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">sync</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span><span style="color: #FFA657">Arc</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">RwLock</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">RwLockReadGuard</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">RwLockWriteGuard</span><span style="color: #C9D1D9">};</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">thread;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">N_THREADS</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> handles</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Vec</span><span style="color: #C9D1D9">&lt;thread</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">JoinHandle</span><span style="color: #C9D1D9">&lt;_&gt;&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Vec</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">with_capacity</span><span style="color: #C9D1D9">(N_THREADS);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> rwlock</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Arc</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">RwLock</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">&gt;&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Arc</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">RwLock</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #C9D1D9">N_THREADS {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> rwlock </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> rwlock</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">clone</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> handle </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">thread</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">spawn</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">move</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">loop</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> guard</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">RwLockReadGuard</span><span style="color: #C9D1D9">&lt;_&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> rwlock</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;thread#{} get read lock&quot;</span><span style="color: #C9D1D9">, n);</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">guard </span><span style="color: #FF7B72">&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;thread#{} is breaking&quot;</span><span style="color: #C9D1D9">, n);</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #FF7B72">break</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">                }</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;thread#{} drop read lock&quot;</span><span style="color: #C9D1D9">, n);</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">thread</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">sleep</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">time</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Duration</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from_secs</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">        });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        handles</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">(handle);</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">loop</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> guard</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">RwLockWriteGuard</span><span style="color: #C9D1D9">&lt;_&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> rwlock</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">write</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;main thread get write lock&quot;</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">guard </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">guard </span><span style="color: #FF7B72">&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;main thread is breaking&quot;</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">break</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;main thread drop write lock&quot;</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">thread</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">sleep</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">time</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Duration</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from_millis</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">500</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(handle) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> handles</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">pop</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">        handle</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">join</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre><p>出力:</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">thread#0 get read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#0 drop read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#1 get read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#1 drop read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#2 get read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#2 drop read lock</span></span>
<span class="line"><span style="color: #c9d1d9">main thread get write lock</span></span>
<span class="line"><span style="color: #c9d1d9">main thread drop write lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#3 get read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#3 drop read lock</span></span>
<span class="line"><span style="color: #c9d1d9">main thread get write lock</span></span>
<span class="line"><span style="color: #c9d1d9">main thread drop write lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#0 get read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#0 drop read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#1 get read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#2 get read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#1 drop read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#3 get read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#3 drop read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#2 drop read lock</span></span>
<span class="line"><span style="color: #c9d1d9">main thread get write lock</span></span>
<span class="line"><span style="color: #c9d1d9">main thread drop write lock</span></span>
<span class="line"><span style="color: #c9d1d9">main thread get write lock</span></span>
<span class="line"><span style="color: #c9d1d9">main thread is breaking</span></span>
<span class="line"><span style="color: #c9d1d9">thread#0 get read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#0 is breaking</span></span>
<span class="line"><span style="color: #c9d1d9">thread#1 get read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#1 is breaking</span></span>
<span class="line"><span style="color: #c9d1d9">thread#3 get read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#3 is breaking</span></span>
<span class="line"><span style="color: #c9d1d9">thread#2 get read lock</span></span>
<span class="line"><span style="color: #c9d1d9">thread#2 is breaking</span></span></code></pre><p>ちょっと長いですが、よくよく見てもらうとwriteロックは必ず排他的にかかるのに対してreadロックは複数同時取得している箇所があります。
readロックは<code>rwlock.read()</code>で、writeロックは<code>rwlock.write()</code>で取得できます。</p><p>Guardが返る点や使い方はMutexと同じです。</p><h1 id="barrier">Barrier</h1><p><a href="https://doc.rust-lang.org/stable/std/sync/struct.Barrier.html">Barrier</a>は複数スレッド間でのタイミングの同期に利用できます。</p><p><code>Barrier::new(n)</code>でBarrierを生成し、<code>n - 1</code>回目の<code>wait()</code>は呼び出し元スレッドをブロックします。
<code>n</code>回目の<code>wait()</code>を呼び出すとすべてのブロックが解除されタイミングが同期できるようになっています。</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">sync</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span><span style="color: #FFA657">Arc</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Barrier</span><span style="color: #C9D1D9">};</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">thread;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">N_THREADS</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> handles </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Vec</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">with_capacity</span><span style="color: #C9D1D9">(N_THREADS);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> barrier</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Arc</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">Barrier</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Arc</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Barrier</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(N_THREADS));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #C9D1D9">N_THREADS {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> barrier </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> barrier</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">clone</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> handle </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">thread</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">spawn</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">move</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;thead#{} is waiting&quot;</span><span style="color: #C9D1D9">, n);</span></span>
<span class="line"><span style="color: #C9D1D9">            barrier</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">wait</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;thead#{} is completed&quot;</span><span style="color: #C9D1D9">, n);</span></span>
<span class="line"><span style="color: #C9D1D9">        });</span></span>
<span class="line"><span style="color: #C9D1D9">        handles</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">(handle);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">thread</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">sleep</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">time</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Duration</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from_secs</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(handle) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> handles</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">pop</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">        handle</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">join</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre><p>出力:</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">thead#0 is waiting</span></span>
<span class="line"><span style="color: #c9d1d9">thead#1 is waiting</span></span>
<span class="line"><span style="color: #c9d1d9">thead#2 is waiting</span></span>
<span class="line"><span style="color: #c9d1d9">thead#3 is waiting</span></span>
<span class="line"><span style="color: #c9d1d9">thead#3 is completed</span></span>
<span class="line"><span style="color: #c9d1d9">thead#2 is completed</span></span>
<span class="line"><span style="color: #c9d1d9">thead#0 is completed</span></span>
<span class="line"><span style="color: #c9d1d9">thead#1 is completed</span></span></code></pre><h1 id="condvar">Condvar</h1><p><a href="https://doc.rust-lang.org/stable/std/sync/struct.Condvar.html">Condvar</a>はスレッド間での通知に利用する条件変数というものです。
Mutexと一緒に利用します。</p><p>RwLockの例では各スレッドで<code>thread::sleep()</code>しながらループすることで待っていました。
これはビジーウェイトやビジーループと呼ばれるパターンで、効率的ではありません。
(CPUの時間を浪費しますし、sleepしている間は順番が回ってきても処理できないので非効率です)</p><p>Condvarを使ってビジーウェイトを回避しつつ他スレッドを待って見ます。
子スレッドでインクリメントしつつ、メインスレッドで10回カウントされるまで待ちます。</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">sync</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span><span style="color: #FFA657">Arc</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Condvar</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Mutex</span><span style="color: #C9D1D9">};</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">thread;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">N_THREADS</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> handles </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Vec</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">with_capacity</span><span style="color: #C9D1D9">(N_THREADS);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> pair </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Arc</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">Mutex</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">), </span><span style="color: #FFA657">Condvar</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">()));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> pair </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pair</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">clone</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> handle </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">thread</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">spawn</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">move</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> (mutex, cvar) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;*</span><span style="color: #C9D1D9">pair;</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #FF7B72">..</span><span style="color: #79C0FF">10</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                {</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> cnt </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> mutex</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">lock</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">cnt </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;child thread incrementes. cnt = {}&quot;</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">cnt);</span></span>
<span class="line"><span style="color: #C9D1D9">                }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">%</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                    cvar</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">notify_one</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">                }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FFA657">thread</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">sleep</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">time</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Duration</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from_millis</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">500</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">            cvar</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">notify_one</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        });</span></span>
<span class="line"><span style="color: #C9D1D9">        handles</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">(handle);</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> (mutex, cvar) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;*</span><span style="color: #C9D1D9">pair;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> cnt </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> mutex</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">lock</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">cnt </span><span style="color: #FF7B72">&lt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">10</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;main thread waiting. cnt = {}&quot;</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">cnt);</span></span>
<span class="line"><span style="color: #C9D1D9">        cnt </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> cvar</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">wait</span><span style="color: #C9D1D9">(cnt)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(handle) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> handles</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">pop</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">        handle</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">join</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre><p>出力:</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">main thread waiting. cnt = 0</span></span>
<span class="line"><span style="color: #c9d1d9">child thread incrementes. cnt = 1</span></span>
<span class="line"><span style="color: #c9d1d9">main thread waiting. cnt = 1</span></span>
<span class="line"><span style="color: #c9d1d9">child thread incrementes. cnt = 2</span></span>
<span class="line"><span style="color: #c9d1d9">child thread incrementes. cnt = 3</span></span>
<span class="line"><span style="color: #c9d1d9">main thread waiting. cnt = 3</span></span>
<span class="line"><span style="color: #c9d1d9">child thread incrementes. cnt = 4</span></span>
<span class="line"><span style="color: #c9d1d9">child thread incrementes. cnt = 5</span></span>
<span class="line"><span style="color: #c9d1d9">main thread waiting. cnt = 5</span></span>
<span class="line"><span style="color: #c9d1d9">child thread incrementes. cnt = 6</span></span>
<span class="line"><span style="color: #c9d1d9">child thread incrementes. cnt = 7</span></span>
<span class="line"><span style="color: #c9d1d9">main thread waiting. cnt = 7</span></span>
<span class="line"><span style="color: #c9d1d9">child thread incrementes. cnt = 8</span></span>
<span class="line"><span style="color: #c9d1d9">child thread incrementes. cnt = 9</span></span>
<span class="line"><span style="color: #c9d1d9">main thread waiting. cnt = 9</span></span>
<span class="line"><span style="color: #c9d1d9">child thread incrementes. cnt = 10</span></span></code></pre><p><code>cvar.notify_one()</code>されるたびに<code>cvar.wait()</code>しているメインスレッドが起動しカウンタの数をチェックしています。
（サンプルのためわざと途中で起動していますが、本来は不要かと）</p><p><code>cvar.wait()</code>は<code>MutexGuard</code>の所有権を取り、所有権を返します。
waitするとnotifyされるまで呼び出しをブロックしつつ、ロックを解除します。</p><p>ぱっと見最初の<code>cnt</code>のロックが保持されたままになっているように見えますが、waitでいったん解除されるため子スレッドをブロックしてデッドロックになったりはしません。
notifyされてメインスレッドに処理が戻ってくると再びMutexGuardを取得しロックがかかります。</p><h1 id="終わりに">終わりに</h1><p><a href="https://doc.rust-lang.org/stable/std/sync/struct.Once.html">Once</a>、<a href="https://doc.rust-lang.org/std/sync/atomic/">std::sync::atomic</a>、
<a href="https://doc.rust-lang.org/std/sync/mpsc/index.html">std::sync::mpsc</a>等ものちのち見ていこうかと思います。</p>
			</main>
		</div>
	</article>
</div>


		</div>
	</body></html>