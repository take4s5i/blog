<!DOCTYPE html>
<html lang="en">
	<head>
		<!-- Google Tag Manager -->
<!-- End Google Tag Manager -->

<!-- Global Metadata -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<link rel="icon" type="image/x-icon" href="/favicon.ico">

<!-- Primary Meta Tags -->
<title>take4s5i DEV - Rustのcrossbeamを試してみる</title>
<meta name="title" content="Rustのcrossbeamを試してみる">
<meta name="description">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url">
<meta property="og:title" content="Rustのcrossbeamを試してみる">
<meta property="og:description">
<meta property="og:image" content="https://astro.build/social.png?v=1">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url">
<meta property="twitter:title" content="Rustのcrossbeamを試してみる">
<meta property="twitter:description">
<meta property="twitter:image" content="https://astro.build/social.png?v=1">

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.gstatic.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=IBM+Plex+Sans:wght@400;700&display=swap">

	<link rel="stylesheet" href="/assets/2df9b0e0.1271b01c.css" /><script type="module">(function(t,n,r,e,m){t[e]=t[e]||[],t[e].push({"gtm.start":new Date().getTime(),event:"gtm.js"});var g=n.getElementsByTagName(r)[0],a=n.createElement(r),s=e!="dataLayer"?"&l="+e:"";a.async=!0,a.src="https://www.googletagmanager.com/gtm.js?id="+m+s,g.parentNode.insertBefore(a,g)})(window,document,"script","dataLayer","GTM-P42NKJ8");
</script></head>

	<body>
		<header class="wrapper astro-63D5MSV2">
	<article class="astro-63D5MSV2">
		<h1 class="astro-63D5MSV2">
			<a href="/" class="astro-63D5MSV2">
				<span class="astro-63D5MSV2">take4s5i DEV</span>
			</a>
		</h1>
	</article>
</header>


		<div class="wrapper">
			<div class="layout astro-U2BRR77M">
	<article class="content astro-U2BRR77M">
		<div class="astro-U2BRR77M">
			<header class="astro-U2BRR77M">
				
				<p class="publish-date astro-U2BRR77M">3 Feb 2022</p>
				<h1 class="title astro-U2BRR77M">Rustのcrossbeamを試してみる</h1>
			</header>
			<main class="astro-U2BRR77M">
				<p>Rustのライブラリである<a href="https://github.com/crossbeam-rs/crossbeam">crossbeam</a>を試してみます。</p><p>crossbeamは公式の説明によると</p><p>This crate provides a set of tools for concurrent programming</p><p>このcrateは並列プログラミングのためのツールセットを提供する、とあります。</p><p>並列プログラミングを行う際のデータ構造や便利な関数が実装されているようです。
それではみていきます。</p><h1 id="crossbeamscope">crossbeam::scope</h1><p><a href="https://docs.rs/crossbeam/0.8.1/crossbeam/fn.scope.html">crossbeam::scope</a>関数は
スコープ付きのスレッドを作ることができます。</p><p>スコープ付きというのはライフタイムが制限されているということです。
通常のスレッドはいつまでスレッドが生きるのかわからないため、スレッドの外から借用するには<code>'static</code>ライフタイムが必要でした。</p><p>スコープ付きスレッドを使うと、Rustコンパイラがスレッドのライフタイムを認識してくれるため、
<code>'static</code>出なくてもデータを借用できるようになります。</p><h2 id="stdthreadでの例">std::threadでの例</h2><p>まずはcrossbeamを使わない普通のstd::threadのコードをみていきます。</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">collections</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">HashMap</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    fs,</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">sync</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span><span style="color: #FFA657">Arc</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Mutex</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> files </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">vec!</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">&quot;a.txt&quot;</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">&quot;b.txt&quot;</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">&quot;c.txt&quot;</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> contents</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Arc</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">Mutex</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">HashMap</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">&gt;&gt;&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Arc</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Mutex</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">HashMap</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">()));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> h </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">vec!</span><span style="color: #C9D1D9">[];</span></span>
<span class="line"><span style="color: #8B949E">    // --------- ここでエラー</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> file </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> files</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">iter</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> file </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> file;</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> contents </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> contents</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">clone</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        h</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">thread</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">spawn</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">move</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> s </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">fs</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">read_to_string</span><span style="color: #C9D1D9">(file)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> m </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> contents</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">lock</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">            m</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">insert</span><span style="color: #C9D1D9">(file</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">to_string</span><span style="color: #C9D1D9">(), s);</span></span>
<span class="line"><span style="color: #C9D1D9">        }));</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(h) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> h</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">pop</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">        h</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">join</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> contents </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Mutex</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">into_inner</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Arc</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">try_unwrap</span><span style="color: #C9D1D9">(contents)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">())</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (f, c) </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> contents</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">iter</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;file: {}&quot;</span><span style="color: #C9D1D9">, f);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;---------------&quot;</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;{}&quot;</span><span style="color: #C9D1D9">, c);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre><p>これはコンパイルエラーになります。</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">error[E0597]: `files` does not live long enough</span></span>
<span class="line"><span style="color: #c9d1d9">  --&gt; src/main.rs:13:17</span></span>
<span class="line"><span style="color: #c9d1d9">   |</span></span>
<span class="line"><span style="color: #c9d1d9">13 |     for file in files.iter() {</span></span>
<span class="line"><span style="color: #c9d1d9">   |                 ^^^^^^^^^^^^</span></span>
<span class="line"><span style="color: #c9d1d9">   |                 |</span></span>
<span class="line"><span style="color: #c9d1d9">   |                 borrowed value does not live long enough</span></span>
<span class="line"><span style="color: #c9d1d9">   |                 argument requires that `files` is borrowed for `&#39;static`</span></span>
<span class="line"><span style="color: #c9d1d9">...</span></span>
<span class="line"><span style="color: #c9d1d9">34 | }</span></span>
<span class="line"><span style="color: #c9d1d9">   | - `files` dropped here while still borrowed</span></span></code></pre><p><code>files</code> からファイル名を借用してスレッドに送っていますが、
子スレッドの方が<code>files</code>より長生きする可能性があるとしてエラーになっています。
（実際のところは, <code>files</code>のライフタイム内で子スレッドをjoinしているため、起こり得ません。）</p><h2 id="crossbeamでの例">crossbeamでの例</h2><p>次にcrossbeamのscope関数を使ってみます。</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">crossbeam</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">thread;</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">collections</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">HashMap</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    fs,</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">sync</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span><span style="color: #FFA657">Arc</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Mutex</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> files </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">vec!</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">&quot;a.txt&quot;</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">&quot;b.txt&quot;</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">&quot;c.txt&quot;</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> contents</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Arc</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">Mutex</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">HashMap</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">&gt;&gt;&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Arc</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Mutex</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">HashMap</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">()));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">thread</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">scope</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">s</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> file </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> files</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">iter</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> file </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> file;</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> contents </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> contents</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">clone</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">            s</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">spawn</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">move</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">_</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> s </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">fs</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">read_to_string</span><span style="color: #C9D1D9">(file)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> m </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> contents</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">lock</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">                m</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">insert</span><span style="color: #C9D1D9">(file</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">to_string</span><span style="color: #C9D1D9">(), s);</span></span>
<span class="line"><span style="color: #C9D1D9">            });</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    })</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> contents </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Mutex</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">into_inner</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Arc</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">try_unwrap</span><span style="color: #C9D1D9">(contents)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">())</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (f, c) </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> contents</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">iter</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;file: {}&quot;</span><span style="color: #C9D1D9">, f);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;---------------&quot;</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;{}&quot;</span><span style="color: #C9D1D9">, c);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre><p>出力:</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">file: b.txt</span></span>
<span class="line"><span style="color: #c9d1d9">---------------</span></span>
<span class="line"><span style="color: #c9d1d9">bbbbbb</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">file: a.txt</span></span>
<span class="line"><span style="color: #c9d1d9">---------------</span></span>
<span class="line"><span style="color: #c9d1d9">aaaaa</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">file: c.txt</span></span>
<span class="line"><span style="color: #c9d1d9">---------------</span></span>
<span class="line"><span style="color: #c9d1d9">ccccc</span></span></code></pre><p>コンパイルが通り期待通り動作しています。</p><p><code>s.spawn</code>で起動したスレッドで手動でjoinする必要はありません。
<code>scope</code>関数は<code>s.spawn</code>したスレッドが全て完了するまで、自動的にブロックします。</p><p>ソースを読んでみた感じだと、
<a href="https://doc.rust-lang.org/std/thread/struct.Builder.html">std::thread::Builder</a>を使って
スレッドを起動させているようでした。</p><p>つまり、スコープ付きで扱えるだけで普通にOSのネイティブスレッドが起動しているため、
グリーンスレッドのようにカジュアルにスレッドを起動する用途には向いていないようです。</p><h1 id="crossbeamchannel">crossbeam::channel</h1><p><a href="https://docs.rs/crossbeam/0.8.1/crossbeam/channel/index.html">crossbeam::channel</a>は
スレッド間のメッセージ送受信に利用するライブラリです。</p><p>使い方は<a href="https://blog.take4s5i.dev/posts/2022/rust-std-sync2/">std::mpsc::channel</a>とほとんど同じです。</p><p>違いとしては、</p><ul>
<li>stdの方は multi-producer, single-consumerに対して</li>
<li>crossbeamの方は multi-producer, multi-consumer
になっていることが挙げられます。</li>
</ul><p>また、公式の説明によるとstdより機能豊富でパフォーマンスが良いそうです。</p><p>チャネルを作るために２種類の関数が提供されており</p><ul>
<li><a href="https://docs.rs/crossbeam/0.8.1/crossbeam/channel/fn.bounded.html">bounded</a>
<ul>
<li>メッセージのバッファが有限</li>
<li>バッファに空きがない場合、<code>send</code>をブロックしてバッファが開くのを待つ</li>
</ul>
</li>
<li><a href="https://docs.rs/crossbeam/0.8.1/crossbeam/channel/fn.unbounded.html">unbounded</a>
<ul>
<li>メモリの許す限りメッセージをバッファすることができる</li>
</ul>
</li>
</ul><p><code>bounded</code>を使ってサンプルを作ってみます。</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">crossbeam</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{channel, thread};</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">fs;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">thread</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">scope</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">s</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> (tx_file, rx_file) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">channel</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">bounded</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">&gt;(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> (tx_content, rx_content) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">channel</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">bounded</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">&lt;(</span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">)&gt;(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">        // sending file name</span></span>
<span class="line"><span style="color: #C9D1D9">        s</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">spawn</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">move</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">_</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> files </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">vec!</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">&quot;a.txt&quot;</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">&quot;b.txt&quot;</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">&quot;c.txt&quot;</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> f </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> files</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">iter</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;[sender] send {}&quot;</span><span style="color: #C9D1D9">, f);</span></span>
<span class="line"><span style="color: #C9D1D9">                tx_file</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">send</span><span style="color: #C9D1D9">(f</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">to_string</span><span style="color: #C9D1D9">())</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">thread</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">sleep</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">time</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Duration</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from_millis</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">200</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">        // reading files</span></span>
<span class="line"><span style="color: #C9D1D9">        s</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">spawn</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">move</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">_</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> file </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> rx_file</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">into_iter</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;[reader] read {}&quot;</span><span style="color: #C9D1D9">, file);</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> content </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">fs</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">read_to_string</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&amp;</span><span style="color: #C9D1D9">file)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">                tx_content</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">send</span><span style="color: #C9D1D9">((file, content))</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">thread</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">sleep</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">time</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Duration</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from_millis</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">500</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">        // consuming results</span></span>
<span class="line"><span style="color: #C9D1D9">        s</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">spawn</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">move</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">_</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (f, c) </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> rx_content</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">into_iter</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">println!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;[consumer] {} = {:?}&quot;</span><span style="color: #C9D1D9">, f, c);</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">thread</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">sleep</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">time</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Duration</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from_millis</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        });</span></span>
<span class="line"><span style="color: #C9D1D9">    })</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre><p>出力:</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">[sender] send a.txt</span></span>
<span class="line"><span style="color: #c9d1d9">[reader] read a.txt</span></span>
<span class="line"><span style="color: #c9d1d9">[consumer] a.txt = &quot;aaaaa\n&quot;</span></span>
<span class="line"><span style="color: #c9d1d9">[sender] send b.txt</span></span>
<span class="line"><span style="color: #c9d1d9">[reader] read b.txt</span></span>
<span class="line"><span style="color: #c9d1d9">[sender] send c.txt</span></span>
<span class="line"><span style="color: #c9d1d9">[consumer] b.txt = &quot;bbbbbb\n&quot;</span></span>
<span class="line"><span style="color: #c9d1d9">[reader] read c.txt</span></span>
<span class="line"><span style="color: #c9d1d9">[consumer] c.txt = &quot;ccccc\n&quot;</span></span></code></pre><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> (tx_file, rx_file) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">channel</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">bounded</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">&gt;(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> (tx_content, rx_content) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">channel</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">bounded</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">&lt;(</span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">)&gt;(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">);</span></span></code></pre><p>まず、スレッド間通信ようのチャネルを<code>bounded</code>を使って作ります。
キャパシティとして<code>0</code>を指定しているので、このチャネルにはバッファがありません。
そのため、<code>send</code>した場合は<code>recv</code>されるまでブロックされることになります。</p><p>後続処理の方が処理時間が長く<code>send</code>をブロックするため綺麗に順番に実行されています。</p><p>これを次のように<code>3</code>で実行してみます。</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> (tx_file, rx_file) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">channel</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">bounded</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">&gt;(</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> (tx_content, rx_content) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">channel</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">bounded</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">&lt;(</span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">)&gt;(</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">);</span></span></code></pre><p>出力:</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">[sender] send a.txt</span></span>
<span class="line"><span style="color: #c9d1d9">[reader] read a.txt</span></span>
<span class="line"><span style="color: #c9d1d9">[consumer] a.txt = &quot;aaaaa\n&quot;</span></span>
<span class="line"><span style="color: #c9d1d9">[sender] send b.txt</span></span>
<span class="line"><span style="color: #c9d1d9">[sender] send c.txt</span></span>
<span class="line"><span style="color: #c9d1d9">[reader] read b.txt</span></span>
<span class="line"><span style="color: #c9d1d9">[consumer] b.txt = &quot;bbbbbb\n&quot;</span></span>
<span class="line"><span style="color: #c9d1d9">[reader] read c.txt</span></span>
<span class="line"><span style="color: #c9d1d9">[consumer] c.txt = &quot;ccccc\n&quot;</span></span></code></pre><p>最初の<code>sender</code>, <code>reader</code>, <code>consumer</code>の順番は同じですが、<code>reader</code>が<code>recv</code>するよりも先に
<code>sernder</code>が<code>send</code>できていることがわかります。</p>
			</main>
		</div>
	</article>
</div>


		</div>
	</body></html>